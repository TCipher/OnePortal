@page "/mfa/webauthn"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@inject OnePortal.Blazor.Services.Auth.AuthService Auth
@inject OnePortal.Blazor.Services.Auth.WebAuthnClient WebAuthn
@inject NavigationManager Nav
@inject IJSRuntime JS



<h1>Passkey / WebAuthn</h1>
<button @onclick="Go">Use Passkey</button>
@if (!string.IsNullOrEmpty(error)) {<div class="error">@error</div>}


@code {
string? error;
private async Task Go()
{
        var email = Auth.GetPrincipal().Identity?.Name ?? await JS.InvokeAsync<string>("localStorage.getItem", "onep.email");
var result = await WebAuthn.AuthenticateAsync(email ?? string.Empty);
if (result.Success) 
{
    Nav.NavigateTo("/dashboard", true);
} 
else if (result.NoPasskeysRegistered)
{
    error = "No passkeys registered. Please add a passkey first.";
}
else
{
    error = result.Error ?? "Passkey auth failed";
}
}
}